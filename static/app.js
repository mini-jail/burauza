var Ve=Symbol(),Le=new Set,H,b;function E(e){let t=q();b=t;try{return X(()=>{let n;return e.length&&(n=D.bind(void 0,t,!0)),e(n)})}catch(n){Q(n)}finally{b=t.parentNode}}function q(e,t){let n={value:e,parentNode:b,children:void 0,injections:void 0,cleanups:void 0,callback:t,sources:void 0,sourceSlots:void 0};return b&&(b.children===void 0?b.children=[n]:b.children.push(n)),n}function _(e){m(()=>O(e))}function $(e){y(()=>O(e))}function S(e,t){return n=>(e(),O(()=>t(n)))}function m(e,t){if(b){let n=q(t,e);H?H.add(n):queueMicrotask(()=>Y(n,!1))}else queueMicrotask(()=>e(t))}function K(e,t){return e?e.injections&&t in e.injections?e.injections[t]:K(e.parentNode,t):void 0}function Me(e){return{value:e,nodes:void 0,nodeSlots:void 0}}function He(e){if(b&&b.callback){let t=e.nodes?.length||0,n=b.sources?.length||0;b.sources===void 0?(b.sources=[e],b.sourceSlots=[t]):(b.sources.push(e),b.sourceSlots.push(t)),e.nodes===void 0?(e.nodes=[b],e.nodeSlots=[n]):(e.nodes.push(b),e.nodeSlots.push(n))}return e.value}function Ae(e,t){typeof t=="function"&&(t=t(e.value)),e.value=t,e.nodes?.length&&X(()=>{for(let n of e.nodes)H.add(n)})}function he(e,t){return arguments.length===1?He(e):Ae(e,t)}function c(e){let t=Me(e);return he.bind(void 0,t)}function Q(e){let t=K(b,Ve);if(!t)return reportError(e);for(let n of t)n(e)}function y(e){b!==void 0&&(b.cleanups?b.cleanups.push(e):b.cleanups=[e])}function O(e){let t=b;b=void 0;let n=e();return b=t,n}function X(e){if(H)return e();H=Le;let t=e();return queueMicrotask(ve),t}function ve(){if(H!==void 0){for(let e of H)H.delete(e),Y(e,!1);H=void 0}}function Y(e,t){if(D(e,t),e.callback===void 0)return;let n=b;b=e;try{e.value=e.callback(e.value)}catch(i){Q(i)}finally{b=n}}function Ee(e){let t,n,i,r;for(;e.sources.length;)t=e.sources.pop(),n=e.sourceSlots.pop(),t.nodes?.length&&(i=t.nodes.pop(),r=t.nodeSlots.pop(),n<t.nodes.length&&(t.nodes[n]=i,t.nodeSlots[n]=r,i.sourceSlots[r]=n))}function Se(e,t){let n=e.callback!==void 0,i;for(;e.children.length;)i=e.children.pop(),D(i,t||n&&i.callback!==void 0)}function D(e,t){e.sources?.length&&Ee(e),e.children?.length&&Se(e,t),e.cleanups?.length&&ke(e),e.injections=void 0,t&&xe(e)}function ke(e){for(;e.cleanups?.length;)e.cleanups.pop()()}function xe(e){e.value=void 0,e.parentNode=void 0,e.children=void 0,e.cleanups=void 0,e.callback=void 0,e.sources=void 0,e.sourceSlots=void 0}var v,w,C,N=new Set;function ne(){return C}function s(e,t){let n=document.createElement(e);t&&ie(n,t),ye(n)}function ie(e,t){if(typeof t=="object")return te(e,void 0,t);e.append(""),m(n=>{let i=w=[];if(v=t.length?Object.create(null):void 0,C=e,t(v),(n?.[1]?.length||i.length)&&Ne(e.firstChild,n?.[1],i),C=void 0,w=void 0,(n?.[0]||v)&&te(e,n?.[0],v),v=void 0,v||i.length)return[v,i]})}function ye(e){w?w.push(e):C?.appendChild(e)}function Ne(e,t,n){let i=e.parentNode;if(t===void 0){for(let T of n)i.insertBefore(T,e);return}let r=t.length,o=n.length,l,a,d;e:for(a=0;a<o;a++){for(l=t[a],d=0;d<r;d++)if(t[d]!==void 0&&(t[d].nodeType===3&&n[a].nodeType===3?(t[d].data!==n[a].data&&(t[d].data=n[a].data),n[a]=t[d]):t[d].isEqualNode(n[a])&&(n[a]=t[d]),n[a]===t[d])){if(t[d]=void 0,a===d)continue e;break}i.insertBefore(n[a],l?.nextSibling||null)}for(;t.length;)t.pop()?.remove()}function J(e){return e.replace(/([A-Z])/g,t=>"-"+t[0]).toLowerCase()}function Z(e){return e.startsWith("on:")?e.slice(3):e.slice(2).toLowerCase()}function ee(e,t,n){t==="text"||t==="textContent"?e.firstChild?.nodeType===3?e.firstChild.data=String(n):e.prepend(String(n)):t in e?e[t]=n:n!==void 0?e.setAttributeNS(null,J(t),String(n)):e.removeAttributeNS(null,J(t))}function te(e,t,n){N.clear(),t&&Object.keys(t).forEach(i=>N.add(i)),n&&Object.keys(n).forEach(i=>N.add(i));for(let i of N){let r=n?.[i],o=t?.[i];if(!(r===void 0&&o===void 0))if(i.startsWith("on")&&o!==r)o&&e.removeEventListener(Z(i),t[i]),r&&e.addEventListener(Z(i),n[i]);else if(typeof r=="function")m(l=>{let a=r();return a!==l&&ee(e,i,a),a});else if(typeof r=="object")for(let l in r)typeof r[l]=="function"?m(a=>{console.log(r[l]);let d=r[l]();return d!==a&&(e[i][l]=d||null),d}):e[i][l]=r[l]||null;else ee(e,i,n?.[i])}}function G(e,t){return E(n=>(ie(e,t),n))}var we=await Ge(),L=c(Ce()),F=E(()=>{let e=()=>[...we,...L()];return m(t=>{let n=L();if(t===!0)return!1;localStorage.setItem("sources",JSON.stringify(n))},!0),e});function Ce(){let e=localStorage.getItem("sources")||"[]";try{return JSON.parse(e)}catch{return[]}}async function Ge(){try{return await(await fetch("./sources.json")).json()}catch{return[]}}function re(){return F()}function Be(e){return F().find(t=>t.url===e)}function ae(){return F()[0]}function se(e){let t=c([]);return m(async()=>{let{page:n=1,limit:i=40,url:r,tags:o}=e(),l=[],a=Be(r)?.url||r;if(a){let d=new URL(a),T=new URLSearchParams;T.set("page",n.toString()),T.set("limit",i.toString()),o?.length&&T.set("tags",o.join(" ")),d.search=T.toString();let u=await fetch(d);if(u.ok){let V=await u.json();for(let f of(Array.isArray(V)?V:V.post)||[])f.id!==void 0&&f.file_url!==void 0&&(f.preview_url===void 0&&f.preview_file_url===void 0||l.push(Pe(r,f)))}}t(l)}),t}function Pe(e,t){let n={id:t.id,fileUrl:t.file_url,previewUrl:t.preview_url||t.preview_file_url,artist:t.tag_string_artist||void 0,tags:[],source:e},i=t.tags||t.tag_string;return i&&n.tags.push(...i.split(" ").filter(r=>r)),n}function oe(e){let t=document.title;m(()=>document.title=e()),$(()=>document.title=t)}var ue=()=>{let e=location.hash;return e.startsWith("#")&&(e=e.slice(1)),e},le=()=>{let e=new URLSearchParams(ue());return{url:e.has("url")?e.get("url"):ae()?.url,page:e.has("page")?~~e.get("page"):1,limit:e.has("limit")?~~e.get("limit"):40,search:e.has("search")?e.get("search"):"",tags:e.has("tags")?e.get("tags").split(",").filter(t=>t):[]}},h=E(()=>{let e=le(),t=c(e.url),n=c(e.limit),i=c(0),r=c(1/0),o=c(e.search),l=c(),a=c(e.tags),d=c(e.page),T=c(),u=se(()=>({url:t(),limit:n(),page:d(),tags:a()})),V=()=>{let g=[];for(let p of u())for(let M of p.tags)g.includes(M)===!1&&g.push(M);return g.sort((p,M)=>p<M?-1:p>M?1:0)},f=g=>!I(g)&&a([...a(),g]),A=g=>a(a().filter(p=>p!==g)),Te=g=>I(g)?A(g):f(g),I=g=>a().includes(g),pe=()=>(t(),a(),void 0),W=g=>{let p=le();t(p.url),d(p.page),n(p.limit),o(p.search),a(p.tags)};return m(S(o,g=>{if(g!==o()){let p=o().split(" ").filter(M=>M);for(let M of p)f(M);d(1)}return o()}),e.search),oe(()=>{let g=`\u30D6\u30E9\u30A6\u30B6\uFF1A${d()}`;return a().length&&(g+=` \u300C${a().join("\u3001 ")}\u300D`),g}),m(S(u,()=>{r(u().length),i(0)})),m(S(pe,g=>{let p=`${t()}${a().join()}`;return g!==p&&d(1),p}),`${t()}${a().join()}`),m(g=>(g.set("page",d().toString()),g.set("limit",n().toString()),g.set("url",t()),o().length?g.set("search",o()):g.delete("search"),a().length?g.set("tags",a().join(",")):g.delete("tags"),removeEventListener("popstate",W),location.hash=g.toString(),addEventListener("popstate",W),g),new URLSearchParams(ue())),{highlighted:l,tags:a,posts:u,postTags:V,page:d,select:T,addTag:f,delTag:A,hasTag:I,toggleTag:Te,search:o,loaded:i,size:r,limit:n,url:t}});function de(){let e=localStorage.getItem("is:pervert")==="true",t="imapervert".split(""),n=c(e),i=0,r=({key:o})=>{if(i===t.length-1){localStorage.setItem("is:pervert","true"),n(!0);return}o!=null&&t[i]!=null&&o.toLowerCase()===t[i].toLowerCase()?i++:(i=0,n(!1))};return m(()=>{y(()=>removeEventListener("keyup",r)),!n()&&addEventListener("keyup",r)}),n}function ge(e,t){return new Promise(n=>{let i=document.createElement("input");i.type="file",i.accept=e,i.onchange=r=>{let o=r.currentTarget.files;if(o===null)return;let l=new FileReader;l.onload=()=>{n(l.result)},l[t](o[0])},i.click()})}function ce(e,t,n){let i=`${t};charset=utf-8,${encodeURIComponent(n)}`,r=document.createElement("a");r.href="data:"+i,r.download=e,r.click()}function Re(e){let t=c(!1),n=c(!1);m(()=>t(e.show())),m(()=>{t()?e.onOpen?.():e.onClose?.()}),s("div",i=>{i.show=t,i.class="window",i.fullscreen=n,i.style={width:e.width,height:e.height},s("div",r=>{r.class="window-title",s("h3",o=>{o.textContent=e.title,o.title=e.title}),s("div",o=>{o.class="window-title-children",e.titleChildren?.(),s("button",l=>{l.class=()=>`icon ${n()?"compress":"enlarge"}`,l.title=()=>`${n()?"compress":"enlarge"} window`,l.onClick=()=>n(!n())}),s("button",l=>{l.class="icon close",l.title="close window",l.onClick=()=>t(!1)})})}),s("div",r=>{r.class="window-content",s("div",o=>{o.class="window-content-wrapper",e.children?.()})})})}var B=Re;function be(e){B({title:()=>"source editor",show:e,titleChildren(){s("button",t=>{t.class="icon download-json",t.title="download sources",t.onClick=()=>ce(`sources-${Date.now()}.json`,"application/json",JSON.stringify(L(),null,2))})},children(){for(let t of L())Oe(t);Ie()}})}function Ie(){let e=c(""),t=c("");s("div",n=>{n.class="flex justify-content-space-betwee flex-gap-10",s("div",i=>{i.class="flex align-items-baseline width-100",s("label",r=>r.textContent="name:"),s("input",r=>{r.class="flex-1",r.name="name",r.value=e,r.onInput=o=>e(o.currentTarget.value),r.placeholder="*Booru"})}),s("div",i=>{i.class="flex align-items-baseline width-100",s("label",r=>r.textContent="url:"),s("input",r=>{r.class="flex-1",r.name="url",r.value=t,r.onInput=o=>t(o.currentTarget.value),r.placeholder="https://..."})}),s("div",i=>{i.class="flex",s("button",r=>{r.class="icon plus",r.title="add source",r.disabled=()=>!e()||!t(),r.onClick=()=>{!e()||!t()||(L(L().concat({name:e(),url:t()})),t(""),e(""))}}),s("button",r=>{r.class="icon import",r.title="import source",r.onClick=async()=>{let o=await ge(".json","readAsText"),l=JSON.parse(o),a=[];if(Array.isArray(l))for(let d of l)d.name&&d.url&&a.push(d);L(L().concat(a))}})})})}function Oe(e){s("div",t=>{t.class="flex justify-content-space-between flex-gap-10",s("div",n=>{n.class="flex align-items-baseline width-100",s("label",i=>i.textContent="name:"),s("input",i=>{i.class="flex-1",i.name="name",i.value=e.name,i.placeholder="*Booru",i.onInput=r=>e.name=r.currentTarget.value})}),s("div",n=>{n.class="flex align-items-baseline width-100",s("label",i=>i.textContent="url:"),s("input",i=>{i.class="flex-1",i.value=e.url,i.placeholder="https://...",i.onInput=r=>e.url=r.currentTarget.value})}),s("div",n=>{n.class="flex",s("button",i=>{i.class="icon check",i.title="save source",i.onClick=()=>{let r={url:e.url,name:e.name};L(L().filter(o=>o!==e).concat(r))}}),s("button",i=>{i.class="icon delete",i.title="delete source",i.onClick=()=>{L(L().filter(r=>r!==e))}})})})}var P=new Map;function me(e,t){let n=c(e);return m(S(t,async()=>{if(t()===!1)return n(e);if(P.has(e))return n(P.get(e));let i=await fetch(`https://danbooru.donmai.us/wiki_pages/${e}.json`);i.status===200?P.set(e,(await i.json()).body):P.set(e,e)})),n}function k(e,t){let{toggleTag:n,tags:i,highlighted:r}=h,o=c(!1),l=me(e,o);s("div",{class:"tag",title:l,textContent:e,artist:t?.artist===e,onClick:()=>n(e),onMouseOver:()=>o(!0),onMouseOut:()=>o(!1),state:()=>{if(i().includes(e))return"active";if(r()?.includes(e))return"highlight"}})}function j(){let{postTags:e,tags:t,page:n,search:i,url:r}=h,o=c(!1),l=c(!1),a=de();s("nav",()=>{be(l),s("div",d=>{d.class="nav-top",s("div",T=>{T.class="flex align-items-center",a()&&s("button",u=>{u.title="choose image source",u.name="source",u.type="button",u.class="icon source z-index-1",s("div",V=>{V.class="sources",s("div",f=>{f.title="open source editor",f.textContent="source editor",f.onClick=()=>l(!l())});for(let f of re())s("div",A=>{A.active=()=>f.url===r(),A.textContent=f.name,A.onClick=()=>r(f.url)})})}),s("button",u=>{u.class="icon tags",u.onClick=()=>o(!o())}),s("input",u=>{u.class="flex-1",u.name="search",u.placeholder="search...",u.value=i,u.type="text";let V;u.onKeyUp=f=>{let A=f.currentTarget.value;clearTimeout(V),V=setTimeout(()=>i(A),1e3)}}),s("button",u=>{u.title="browse source",u.name="sourcecode",u.type="button",u.class="icon sourcecode",u.onClick=()=>{open("https://github.com/mini-jail/burauza","_blank")}})}),s("div",T=>{T.class="nav-paging",s("button",u=>{u.class="previous",u.textContent=()=>String(n()-1),u.disabled=()=>n()<=1,u.onClick=()=>n(n()-1)}),s("button",u=>{u.class="current",u.disabled=!0,u.textContent=()=>String(n())}),s("button",u=>{u.class="next",u.textContent=()=>String(n()+1),u.onClick=()=>n(n()+1)})})}),s("div",d=>{d.class="tag-list overflow-auto flex-1",d.show=o;let T=t(),u=e().filter(V=>!T.includes(V));for(let V of T)k(V);for(let V of u)k(V)})})}var x=c(new Set);function fe(){let e;G(document.body,()=>{s("div",t=>{t.class="loading-wrapper";for(let n of x())s("div",i=>{i.class="loading",i.textContent=n.text,i.loading=()=>{let r=n.on();return clearTimeout(e),n.on()&&(x().delete(n),e=setTimeout(()=>x(x()),2e3)),r}})})})}function R(e){queueMicrotask(()=>x(x().add(e)))}var De=["jpg","jpeg","bmp","png","gif"],Fe=e=>e.split(".").at(-1),je=e=>{let t=Fe(e);return t===void 0?!1:De.includes(t)};function U(){let{select:e,posts:t}=h,n=c(!1);m(()=>{y(()=>n(!1))});let i=l=>{l.key==="ArrowRight"?o():l.key==="ArrowLeft"&&r()},r=()=>{let l=t().indexOf(e()),a=l-1===-1?t().length-1:l-1;e(t()[a])},o=()=>{let l=t().indexOf(e()),a=l+1===t().length?0:l+1;e(t()[a])};B({title:()=>String(e()?.fileUrl),show:n,width:"100%",onOpen:()=>addEventListener("keyup",i),onClose:()=>removeEventListener("keyup",i),titleChildren(){s("button",{class:"icon left",onClick:r}),s("button",{class:"icon right",onClick:o}),s("button",{class:"icon curly-arrow",title:"open file in new tab",onClick:()=>open(e().fileUrl,"_blank")})},children(){s("div",l=>{l.class="preview";let a=e();a!==void 0&&(R({on:n,text:()=>`loading "${a.id}"`}),s("img",{class:"preview-img",src:je(a.fileUrl)?a.fileUrl:a.previewUrl,alt:a.fileUrl,onLoad:()=>n(!0),onError:d=>{d.currentTarget.src===a.fileUrl&&(d.currentTarget.src=a.previewUrl)}}),s("div",d=>{d.class="tag-list";for(let T of a.tags)k(T,a)}))})}})}function z(){let{posts:e,highlighted:t,select:n,loaded:i,size:r}=h;s("main",o=>{let l=ne();o.ready=()=>r()<=i(),R({on:()=>r()<=i(),text:()=>`loading posts ${i()}/${r()}`}),_(()=>l.scrollTo({top:0,behavior:"smooth"}));for(let a of e())s("article",()=>{s("img",{src:a.previewUrl,alt:a.previewUrl,onClick:()=>n(a),onLoad:()=>i(i()+1),onError:()=>i(i()+1),onMouseOver:()=>t(a.tags),onMouseOut:()=>t(void 0)})})})}fe();G(document.body,()=>{j(),z(),U()});
//# sourceMappingURL=app.js.map
