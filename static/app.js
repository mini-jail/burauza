var He=Symbol(),w=new Set,k=!1,c=null;function v(e){c=$();try{return J(()=>{let t;return e.length&&(t=j.bind(void 0,c,!0)),e(t)})}catch(t){Q(t)}finally{c=c.parentNode}}function $(e,t){let n={value:e,parentNode:c,children:null,injections:null,cleanups:null,callback:t||null,sources:null,sourceSlots:null};return c&&(c.children===null?c.children=[n]:c.children.push(n)),n}function K(e){b(()=>F(e))}function X(e){x(()=>F(e))}function A(e,t){return n=>(e(),F(()=>t(n)))}function b(e,t){if(c){let n=$(t,e);k?w.add(n):queueMicrotask(()=>Z(n,!1))}else queueMicrotask(()=>e(t))}function Y(e,t){return e?e.injections&&t in e.injections?e.injections[t]:Y(e.parentNode,t):void 0}function Ae(e){return{value:e,nodes:null,nodeSlots:null}}function he(e){if(c&&c.callback){let t=e.nodes?.length||0,n=c.sources?.length||0;c.sources===null?(c.sources=[e],c.sourceSlots=[t]):(c.sources.push(e),c.sourceSlots.push(t)),e.nodes===null?(e.nodes=[c],e.nodeSlots=[n]):(e.nodes.push(c),e.nodeSlots.push(n))}return e.value}function ve(e,t){typeof t=="function"&&(t=t(e.value)),e.value=t,e.nodes?.length&&J(()=>{for(let n of e.nodes)w.add(n)})}function Ee(e,t){return arguments.length===1?he(e):ve(e,t)}function d(e){let t=Ae(e);return Ee.bind(void 0,t)}function Q(e){let t=Y(c,He);if(!t)return reportError(e);for(let n of t)n(e)}function x(e){c!==null&&(c.cleanups?c.cleanups.push(e):c.cleanups=[e])}function F(e){let t=c;c=null;let n=e();return c=t,n}function J(e){if(k)return e();k=!0;let t=e();return queueMicrotask(Se),t}function Se(){if(k!==!1){for(let e of w)w.delete(e),Z(e,!1);k=!1}}function Z(e,t){if(j(e,t),e.callback===null)return;let n=c;c=e;try{e.value=e.callback(e.value)}catch(i){Q(i)}finally{c=n}}function ke(e){let t,n,i,r;for(;e.sources.length;)t=e.sources.pop(),n=e.sourceSlots.pop(),t.nodes?.length&&(i=t.nodes.pop(),r=t.nodeSlots.pop(),n<t.nodes.length&&(t.nodes[n]=i,t.nodeSlots[n]=r,i.sourceSlots[r]=n))}function xe(e,t){let n=e.callback!==void 0,i;for(;e.children.length;)i=e.children.pop(),j(i,t||n&&i.callback!==void 0)}function j(e,t){e.sources?.length&&ke(e),e.children?.length&&xe(e,t),e.cleanups?.length&&ye(e),e.injections=null,t&&Ne(e)}function ye(e){for(;e.cleanups?.length;)e.cleanups.pop()()}function Ne(e){e.value=null,e.parentNode=null,e.children=null,e.cleanups=null,e.callback=null,e.sources=null,e.sourceSlots=null}var C=null,B=null,P=null,G=new Set;function re(){return P}function s(e,t){let n=document.createElement(e);t&&ae(n,t),we(n)}function ae(e,t){if(typeof t=="object")return ie(e,null,t);e.append(""),b(n=>{let i=B=[],r=C=t.length?Object.create(null):void 0;if(P=e,t(r),(n?.[1]?.length||i.length)&&Ce(e.firstChild,n?.[1],i),P=null,B=null,(n?.[0]||C)&&ie(e,n?.[0],C),C=null,r||i.length)return[r,i]})}function we(e){B?B.push(e):P?.appendChild(e)}function Ce(e,t,n){let i=e.parentNode;if(t===void 0){for(let m of n)i.insertBefore(m,e);return}let r=t.length,o=n.length,u,a,l;e:for(a=0;a<o;a++){for(u=t[a],l=0;l<r;l++)if(t[l]!==void 0&&(t[l].nodeType===3&&n[a].nodeType===3?(t[l].data!==n[a].data&&(t[l].data=n[a].data),n[a]=t[l]):t[l].isEqualNode(n[a])&&(n[a]=t[l]),n[a]===t[l])){if(t[l]=void 0,a===l)continue e;break}i.insertBefore(n[a],u?.nextSibling||null)}for(;t.length;)t.pop()?.remove()}function ee(e){return e.replace(/([A-Z])/g,t=>"-"+t[0]).toLowerCase()}function te(e){return e.startsWith("on:")?e.slice(3):e.slice(2).toLowerCase()}function ne(e,t,n){if(t==="text"||t==="textContent")e.firstChild?.nodeType===3?e.firstChild.data=String(n):e.prepend(String(n));else if(typeof n=="object")for(let i in n)typeof n[i]=="function"?b(r=>{let o=n[i]();return o!==r&&(e[t][i]=o||null),o}):e[t][i]=n[i]||null;else t in e?e[t]=n:n!==void 0?e.setAttributeNS(null,ee(t),String(n)):e.removeAttributeNS(null,ee(t))}function ie(e,t,n){G.clear(),t&&Object.keys(t).forEach(r=>G.add(r)),n&&Object.keys(n).forEach(r=>G.add(r));let i;for(let r of G){let o=n?.[r],u=t?.[r];o===void 0&&u===void 0||(r.startsWith("on")&&u!==o?(u&&e.removeEventListener(te(r),t[r]),o&&e.addEventListener(te(r),n[r])):typeof o=="function"?i===void 0?i=[r]:i.push(r):ne(e,r,n?.[r]))}i&&b(r=>{for(let o of i){let u=n[o]();r[o]!==u&&(ne(e,o,u),r[o]=u)}return r},{})}function R(e,t){return v(n=>(ae(e,t),n))}var Ge=await Pe(),L=d(Be()),U=v(()=>{let e=()=>[...Ge,...L()];return b(t=>{let n=L();if(t===!0)return!1;localStorage.setItem("sources",JSON.stringify(n))},!0),e});function Be(){let e=localStorage.getItem("sources")||"[]";try{return JSON.parse(e)}catch{return[]}}async function Pe(){try{return await(await fetch("./sources.json")).json()}catch{return[]}}function se(){return U()}function Re(e){return U().find(t=>t.url===e)}function oe(){return U()[0]}var y=new URLSearchParams;function le(e){let t=d([]);return b(async()=>{let{page:n=1,limit:i=40,url:r,tags:o}=e(),u=[],a=Re(r)?.url||r;if(a){let l=new URL(a);y.set("page",n.toString()),y.set("limit",i.toString()),y.delete("tags"),o?.length&&y.set("tags",o.join(" ")),l.search=y.toString();let m=await fetch(l);if(m.ok){let p=await m.json();for(let T of(Array.isArray(p)?p:p.post)||[])T.id!==void 0&&T.file_url!==void 0&&(T.preview_url===void 0&&T.preview_file_url===void 0||u.push(Oe(T)))}}t(u)}),t}function Oe(e){return{id:e.id,fileUrl:e.file_url,fileExtension:String(e.file_url.split(".").at(-1)),previewUrl:e.preview_url||e.preview_file_url,artist:e.tag_string_artist||void 0,tags:De(e),dimensions:Ie(e)}}function De(e){let t=[];return(e.tags||e.tag_string)&&t.push(...(e.tags||e.tag_string).split(" ")),t}function Ie(e){let t=e.image_width||e.width,n=e.image_height||e.height;return[t,n]}function ue(e){let t=document.title;b(()=>document.title=e()),X(()=>document.title=t)}function de(){let e=location.hash;return e.startsWith("#")&&(e=e.slice(1)),e}function ge(){let e=new URLSearchParams(de());return{url:e.has("url")?e.get("url"):oe()?.url,page:e.has("page")?~~e.get("page"):1,limit:e.has("limit")?~~e.get("limit"):40,search:e.has("search")?e.get("search"):"",tags:e.has("tags")?e.get("tags").split(",").filter(t=>t):[]}}var M=v(()=>{let e=ge(),t=d(e.url),n=d(e.limit),i=d(0),r=d(1/0),o=d(e.search),u=d(),a=d(e.tags),l=d(e.page),m=d(),p=le(()=>({url:t(),limit:n(),page:l(),tags:a()})),T=()=>{let g=[];for(let f of p())for(let H of f.tags)g.includes(H)===!1&&g.push(H);return g.sort((f,H)=>f<H?-1:f>H?1:0)},V=g=>!I(g)&&a([...a(),g]),h=g=>a(a().filter(f=>f!==g)),Le=g=>I(g)?h(g):V(g),I=g=>a().includes(g),Me=()=>(t(),a(),void 0),q=g=>{let f=ge();t(f.url),l(f.page),n(f.limit),o(f.search),a(f.tags)};return b(A(o,g=>{if(g!==o()){let f=o().split(" ").filter(H=>H);for(let H of f)V(H);l(1)}return o()}),e.search),ue(()=>{let g=`\u30D6\u30E9\u30A6\u30B6\uFF1A${l()}`;return a().length&&(g+=` \u300C${a().join("\u3001 ")}\u300D`),g}),b(A(p,()=>{r(p().length),i(0)})),b(A(Me,g=>{let f=`${t()}${a().join()}`;return g!==f&&l(1),f}),`${t()}${a().join()}`),b(g=>(g.set("page",l().toString()),g.set("limit",n().toString()),g.set("url",t()),o().length?g.set("search",o()):g.delete("search"),a().length?g.set("tags",a().join(",")):g.delete("tags"),removeEventListener("popstate",q),location.hash=g.toString(),addEventListener("popstate",q),g),new URLSearchParams(de())),{highlighted:u,tags:a,posts:p,postTags:T,page:l,select:m,addTag:V,delTag:h,hasTag:I,toggleTag:Le,search:o,loaded:i,size:r,limit:n,url:t}});function ce(){let e=localStorage.getItem("is:pervert")==="true",t="imapervert".split(""),n=d(e),i=0,r=({key:o})=>{if(i===t.length-1){localStorage.setItem("is:pervert","true"),n(!0);return}o!=null&&t[i]!=null&&o.toLowerCase()===t[i].toLowerCase()?i++:(i=0,n(!1))};return b(()=>{x(()=>removeEventListener("keyup",r)),!n()&&addEventListener("keyup",r)}),n}function be(e,t){return new Promise(n=>{let i=document.createElement("input");i.type="file",i.accept=e,i.onchange=r=>{let o=r.currentTarget.files;if(o===null)return;let u=new FileReader;u.onload=()=>{n(u.result)},u[t](o[0])},i.click()})}function me(e,t,n){let i=`${t};charset=utf-8,${encodeURIComponent(n)}`,r=document.createElement("a");r.href="data:"+i,r.download=e,r.click()}function N(e){let t=d(!1),n=d(!1),i=()=>n(!n()),r=()=>t(!1),o=()=>`${n()?"compress":"enlarge"} window`,u=()=>`icon ${n()?"compress":"enlarge"}`;b(A(e.show,()=>t(e.show()))),b(A(t,()=>t()?e.onOpen?.():e.onClose?.())),s("div",a=>{a.show=t,a.class="window",a.fullscreen=n,a.style={width:e.width,height:e.height},s("div",l=>{l.class="window-title",s("h3",{title:e.title,textContent:e.title}),s("div",m=>{m.class="window-title-children",e.titleChildren?.(),s("button",{type:"button",class:u,title:o,onClick:i}),s("button",{class:"icon close",type:"button",title:"close window",onClick:r})})}),s("div",l=>{l.class="window-content",s("div",m=>{m.class="window-content-wrapper",e.children?.()})})})}function fe(e){N({title:()=>"source editor",show:e,titleChildren(){s("button",{class:"icon download-json",title:"download sources",onClick(){me(`sources-${Date.now()}.json`,"application/json",JSON.stringify(L(),null,2))}})},children(){for(let t of L())je(t);Fe()}})}function Fe(){let e=d(""),t=d("");s("div",n=>{n.class="flex justify-content-space-betwee flex-gap-10",s("div",i=>{i.class="flex align-items-baseline width-100",s("label",{textContent:"name:"}),s("input",{class:"flex-1",name:"name",placeholder:"*Booru",value:e,onInput(r){e(r.currentTarget.value)}})}),s("div",i=>{i.class="flex align-items-baseline width-100",s("label",{textContent:"url:"}),s("input",{class:"flex-1",name:"url",value:t,onInput:r=>t(r.currentTarget.value),placeholder:"https://..."})}),s("div",i=>{i.class="flex",s("button",{class:"icon plus",title:"add source",disabled:()=>!e()||!t(),onClick(){!e()||!t()||(L(L().concat({name:e(),url:t()})),t(""),e(""))}}),s("button",{class:"icon import",title:"import source",async onClick(){let r=await be(".json","readAsText"),o=JSON.parse(r),u=[];if(Array.isArray(o))for(let a of o)a.name&&a.url&&u.push(a);L(L().concat(u))}})})})}function je(e){s("div",t=>{t.class="flex justify-content-space-between flex-gap-10",s("div",n=>{n.class="flex align-items-baseline width-100",s("label",{textContent:"name:"}),s("input",{class:"flex-1",name:"name",value:e.name,placeholder:"*Booru",onInput(i){e.name=i.currentTarget.value}})}),s("div",n=>{n.class="flex align-items-baseline width-100",s("label",{textContent:"url:"}),s("input",{class:"flex-1",value:e.url,placeholder:"https://...",onInput(i){e.url=i.currentTarget.value}})}),s("div",n=>{n.class="flex",s("button",{class:"icon check",title:"save source",onClick(){let i={url:e.url,name:e.name};L(L().filter(r=>r!==e).concat(i))}}),s("button",{class:"icon delete",title:"delete source",onClick(){L(L().filter(i=>i!==e))}})})})}var O=new Map;function Te(e,t){let n=d(e);return b(A(t,async()=>{if(t()===!1)return n(e);if(O.has(e))return n(O.get(e));let i=await fetch(`https://danbooru.donmai.us/wiki_pages/${e}.json`);i.status===200?O.set(e,(await i.json()).body):O.set(e,e)})),n}addEventListener("click",e=>{let t=e.target?.dataset?.tag;t&&M.toggleTag(t)});function Ue(){return M.tags().includes(this)?"active":M.highlighted()?.includes(this)?"highlight":"inactive"}function E(e,t){let n=d(!1),i=Te(e,n);s("div",{class:"tag",dataTag:e,artist:t?.artist===e,onMouseOver:()=>n(!0),onMouseOut:()=>n(!1),state:Ue.bind(e)})}function z(){let{postTags:e,tags:t,page:n,search:i,url:r}=M,o=d(!1),u=d(!1),a=ce(),l;s("nav",()=>{fe(u),s("div",m=>{m.class="nav-top",s("div",p=>{p.class="flex align-items-center",a()&&s("button",T=>{T.title="choose image source",T.name="source",T.type="button",T.class="icon source z-index-1",s("div",V=>{V.class="sources",s("div",{title:"open source editor",textContent:"source editor",onClick:()=>u(!u())});for(let h of se())s("div",{active:()=>h.url===r(),textContent:h.name,onClick:()=>r(h.url)})})}),s("button",{class:"icon tags",title:"show tags",onClick:()=>o(!o())}),s("input",{class:"flex-1",name:"search",placeholder:"search...",value:i,type:"text",onKeyUp(T){let V=T.currentTarget.value;clearTimeout(l),l=setTimeout(()=>i(V),1e3)}}),s("button",{title:"browse source",name:"sourcecode",type:"button",class:"icon sourcecode",onClick(){open("https://github.com/mini-jail/burauza","_blank")}})}),s("div",p=>{p.class="nav-paging",s("button",{title:"show previous page",class:"previous",textContent:()=>String(n()-1),disabled:()=>n()<=1,onClick:()=>n(n()-1)}),s("button",{title:"current page",class:"current",disabled:!0,textContent:()=>String(n())}),s("button",{title:"show next page",class:"next",textContent:()=>String(n()+1),onClick:()=>n(n()+1)})})}),s("div",m=>{m.class="tag-list overflow-auto flex-1",m.show=o;let p=t(),T=e().filter(V=>!p.includes(V));for(let V of p)E(V);for(let V of T)E(V)})})}var S=d(new Set);function pe(){R(document.body,()=>{s("div",e=>{e.class="loading-wrapper";for(let t of S())s("div",{class:"loading",textContent:t.text,loading:()=>{let n=t.on();return n&&(S().delete(t),S(S())),n}})})})}function D(e){queueMicrotask(()=>S(S().add(e)))}var ze=["jpg","jpeg","bmp","png","gif"],We=e=>e.split(".").at(-1),_e=e=>{let t=We(e);return t===void 0?!1:ze.includes(t)};function W(){let{select:e,posts:t}=M,n=d(!1);x(()=>n(!1));let i=u=>{u.key==="ArrowRight"?o():u.key==="ArrowLeft"&&r()},r=()=>{let u=t().indexOf(e()),a=u-1===-1?t().length-1:u-1;e(t()[a])},o=()=>{let u=t().indexOf(e()),a=u+1===t().length?0:u+1;e(t()[a])};N({title:()=>String(e()?.fileUrl),show:n,width:"100%",onOpen:()=>addEventListener("keyup",i),onClose:()=>removeEventListener("keyup",i),titleChildren(){s("button",{title:"show previous post",class:"icon left",onClick:r}),s("button",{title:"show next post",class:"icon right",onClick:o}),s("button",{title:"open file in new tab",class:"icon curly-arrow",onClick:()=>open(e().fileUrl,"_blank")})},children(){s("div",u=>{u.class="preview";let a=e();a!==void 0&&(D({on:n,text:()=>`loading "${a.id}"`}),s("img",{class:"preview-img",src:_e(a.fileUrl)?a.fileUrl:a.previewUrl,alt:a.fileUrl,onLoad:()=>n(!0),onError:l=>{l.currentTarget.src===a.fileUrl&&(l.currentTarget.src=a.previewUrl)}}),s("div",l=>{l.class="tag-list";for(let m of a.tags)E(m,a)}))})}})}function Ve(){M.loaded(M.loaded()+1)}function qe(){M.highlighted(void 0)}function _(){let{posts:e,highlighted:t,select:n,loaded:i,size:r}=M;s("main",o=>{let u=re();o.ready=()=>r()<=i(),D({on:()=>r()<=i(),text:()=>`loading posts ${i()}/${r()}`}),K(()=>u.scrollTo({top:0,behavior:"smooth"}));for(let a of e())s("article",l=>{l.dataId=a.id,l.dataDimensions=a.dimensions.join("x"),l.onClick=()=>n(a),l.onMouseUp=m=>{m.button===1&&open(a.fileUrl,"_blank")},l.onMouseOver=()=>t(a.tags),l.onMouseOut=qe,s("img",{src:a.previewUrl,alt:a.previewUrl,onLoad:Ve,onError:Ve})})})}pe();R(document.body,()=>{z(),_(),W()});
//# sourceMappingURL=app.js.map
